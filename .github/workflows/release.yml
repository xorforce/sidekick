name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build and release (e.g., v0.1.0)"
        required: true
        type: string

jobs:
  build-and-release:
    name: Build binary and attach to GitHub release
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      RELEASE_REF: ${{ github.event_name == 'workflow_dispatch' && github.sha || github.ref }}
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_REF }}

      - name: Get build path
        id: build_path
        run: echo "path=$(swift build -c release --show-bin-path)" >> $GITHUB_OUTPUT

      - name: Build (release)
        run: swift build -c release

      - name: Package binary
        run: |
          mkdir -p dist
          cp ${{ steps.build_path.outputs.path }}/sidekick dist/sidekick
          tar -czvf sidekick-cli-${{ env.RELEASE_TAG }}-macos.tar.gz -C dist sidekick

      - name: Upload artifact (for downstream jobs)
        uses: actions/upload-artifact@v4
        with:
          name: sidekick-cli-macos-tar
          path: sidekick-cli-${{ env.RELEASE_TAG }}-macos.tar.gz
          retention-days: 7

      - name: Attach to GitHub release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: sidekick-cli-${{ env.RELEASE_TAG }}-macos.tar.gz

  check-homebrew-secret:
    name: Check Homebrew secret availability
    runs-on: ubuntu-latest
    needs: build-and-release
    outputs:
      secret_available: ${{ steps.check.outputs.secret_available }}
    steps:
      - name: Check for HOMEBREW_TAP_PAT
        id: check
        run: |
          if [ -n "${{ secrets.HOMEBREW_TAP_PAT }}" ]; then
            echo "secret_available=true" >> $GITHUB_OUTPUT
          else
            echo "secret_available=false" >> $GITHUB_OUTPUT
          fi

  homebrew:
    name: Update Homebrew tap
    runs-on: ubuntu-latest
    env:
      TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_PAT }}
      TAP_REPO: ${{ github.repository }}
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
    needs: [build-and-release, check-homebrew-secret]
    if: ${{ needs.check-homebrew-secret.outputs.secret_available == 'true' }}
    steps:
      - name: Download packaged binary
        uses: actions/download-artifact@v4
        with:
          name: sidekick-cli-macos-tar

      - name: Compute SHA256
        id: sha
        run: echo "sha=$(shasum -a 256 sidekick-cli-${{ env.RELEASE_TAG }}-macos.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Clone tap repo
        run: |
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/xorforce/homebrew-tap.git tap

      - name: Update formula
        env:
          SHA256: ${{ steps.sha.outputs.sha }}
        run: |
          VERSION=${RELEASE_TAG#v}
          REPO=${TAP_REPO}
          URL="https://github.com/${REPO}/releases/download/${RELEASE_TAG}/sidekick-cli-${RELEASE_TAG}-macos.tar.gz"

          cat > tap/Formula/sidekick.rb <<EOF
          class Sidekick < Formula
            desc "A quirky CLI for building, running, and testing iOS/macOS apps"
            homepage "https://github.com/${REPO}"
            url "${URL}"
            sha256 "${SHA256}"
            version "${VERSION}"
            license "MIT"

            def install
              bin.install "sidekick"
            end

            test do
              system "#{bin}/sidekick", "--version"
            end
          end
          EOF

      - name: Commit and push to tap
        working-directory: tap
        run: |
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git status
          git remote -v
          git diff --staged --quiet || git commit -m "Update to v$VERSION"
          git push
