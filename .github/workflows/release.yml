name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build and release (e.g., v0.1.0)"
        required: true
        type: string

jobs:
  build-and-release:
    name: Build binary and attach to GitHub release
    runs-on: macos-latest
    env:
      RELEASE_REF: ${{ github.event_name == 'workflow_dispatch' && format('refs/tags/{0}', inputs.tag) || github.ref }}
      RELEASE_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_REF }}

      - name: Build (release)
        run: swift build -c release

      - name: Package binary
        run: |
          mkdir -p dist
          cp .build/apple/Products/Release/sidekick dist/sidekick
          tar -czvf sidekick-cli-${{ env.RELEASE_NAME }}-macos.tar.gz -C dist sidekick

      - name: Upload artifact (for downstream jobs)
        uses: actions/upload-artifact@v4
        with:
          name: sidekick-cli-macos-tar
          path: sidekick-cli-${{ env.RELEASE_NAME }}-macos.tar.gz
          retention-days: 7

      - name: Attach to GitHub release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_NAME }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          files: sidekick-cli-${{ env.RELEASE_NAME }}-macos.tar.gz

  homebrew:
    name: Update Homebrew tap
    runs-on: macos-latest
    needs: build-and-release
    env:
      HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
      TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO }}
      RELEASE_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
    if: ${{ env.HOMEBREW_TAP_PAT != '' }}
    steps:
      - name: Download packaged binary
        uses: actions/download-artifact@v4
        with:
          name: sidekick-cli-macos-tar

      - name: Compute SHA256
        id: sha
        run: echo "sha=$(shasum -a 256 sidekick-cli-${{ env.RELEASE_NAME }}-macos.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Clone tap repo
        run: |
          REPO="${TAP_REPO:-xorforce/homebrew-tap}"
          git clone https://${HOMEBREW_TAP_PAT}@github.com/${REPO} tap

      - name: Update formula
        env:
          SHA256: ${{ steps.sha.outputs.sha }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          REPO=${GITHUB_REPOSITORY}
          URL="https://github.com/${REPO}/releases/download/${RELEASE_NAME}/sidekick-cli-${RELEASE_NAME}-macos.tar.gz"

          cat > tap/Formula/sidekick.rb <<'EOF'
          class Sidekick < Formula
            desc "A quirky CLI for building, running, and testing iOS/macOS apps"
            homepage "https://github.com/${REPO}"
            url "${URL}"
            sha256 "${SHA256}"
            version "${VERSION}"
            license "MIT"

            def install
              bin.install "sidekick"
            end

            test do
              system "#{bin}/sidekick", "--version"
            end
          end
          EOF

      - name: Commit and push to tap
        working-directory: tap
        run: |
          git config user.name "sidekick-bot"
          git config user.email "bot@example.com"
          git add Formula/sidekick.rb
          git commit -m "Update sidekick to ${GITHUB_REF_NAME} (ci)"
          git push origin HEAD
